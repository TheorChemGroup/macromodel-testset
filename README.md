# MacroModel testset - structure preparation workflow

Original publication of the MacroModel testset - https://doi.org/10.1021/ci5001696

## Clone

```
git clone --recurse-submodules https://gitlab.com/knvvv/macromodel-testset.git
```

## Prerequisites

* CSD Python API
* `pip install pypdb`
* Download BuildModel into directory `./assemble_initial/build_model` 

## Prepare initial structures

```
cd assemble_initial
```

Directory layout:

| assemble_initial/ |  |
| -------- | -------- |
| *Directories* |  |
| `raw_data/` | Starting info about MacroModel testset taken from SI of J. Chem. Inf. Model. 2014, 54, 10, 2680–2696 |
| `parsed_testmols/` | SDFs of 150 test molecules created by parse_*.py scripts with corrections by hand for some molecules |
| `nbo_gjfs/` | GJF files of NBO calculations needed to determinde molecular topology. Generated by gen_gjf.py |
| `nbo_logs/` | LOG files of NBO calculations. Must be obtained manually from nbo_gjfs/*.gjf files. |
| `optinitial_conformers/` | Molecules from parsed_testmols/ with corrected topologies and optimized geometries. Created by fix_and_optimize.py |
| *Files* |  |
| `*.py` | Various driver scripts that are discussed below |
| `nbo_template.gjf` | Template for NBO calculations in Gaussian |

### Obtain geometries from databases and sanitize hydrogens

The main problem with starting structures is the placement of hydrogen atoms as they are either missing or placed badly to say the least. 

```
python parse_pdb.py
python parse_pdb2.py
python parse_csd.py
```

`python parse_pdb.py` - Takes molecules from SI of J. Chem. Inf. Model. 2014, 54, 10, 2680–2696. Uses BuildModel to fix hydrogens

`python parse_pdb2.py` - In cases where `parse_pdb.py` failed, download and process test molecules from PDB website. Uses BuildModel to fix hydrogens.

`python parse_csd.py` - Gets test molecules from CCDC and adds missing hydrogens using custom python script.

Still, after applying these scripts. Several PDB molecules have some hydrogens that were misplaced or missed by BuildModel. These problems were fixed by hand in the following molecules:

* pdb_1PFE.sdf
* pdb_1QZ6.sdf
* pdb_1S22.sdf
* pdb_2VYP.sdf
* pdb_3EKS.sdf
* pdb_3KEE.sdf
* pdb_1E9W.sdf
* pdb_2WHW.sdf
* pdb_1MRL.sdf
* pdb_2GPL.sdf
* pdb_2IYA.sdf

### Generate topology

```
python gen_gjf.py
# Perform Gaussian calculations and copy the resulting logs into nbo_logs/
python fix_and_optimize.py
```

Its important to standardize bond types as databases randomly place aromatic bond types on some amide bonds, for example. NBO usually gives reasonable bond orders, so we use it to refine topologies in SDF files `parsed_testmols/*.sdf`.

Since NBO also fails in some cases (probably, due to very small basis), `fix_and_optimize.py` introduces some corrections to bonds and their orders. Also, `fix_and_optimize.py` adds atomic charges and verifies them against total molecular charges derived by manually (see `charges.py`).

After setting atomic charges and correcting bond orders we can use RDKit for geometry optimization using MMFF (couldn't do that earlier because RDKit is very picky to bond orders and atomic charges).

Check visually that all molecules are fine and move on.

## Build testset of randomized conformers

```
cd randomize_startmolecule
```

Directory layout:

| randomize_startmolecule/ |  |
| -------- | -------- |
| *Directories* |  |
| `test_systems/` | Copy from `../assemble_initial/optinitial_conformers` |
| `start_conformers/` | Randomized conformations of molecules from test_systems |
| `chemscripts/` | Utility scripts |
| *Files* |  |
| `*.py` | Various driver scripts that are discussed below |
| `niso_timings.json` | JSON with numbers of automorphisms |

To effectively use Ringo, we first need to compute numbers of molecular graph automorphisms because some test molecules have very large numbers of symmetries (for example, 24576 for csd_VOKBIG). In such complicated cases, it's better to use simplified approach for RMSD calculation.

Ringo is not always able to randomize macrocycle because two test molecules (pdb_1KEG, pdb_1EHL) have such molecular graphs that TLC applicability conditions are not satisfied. In these two cases we randomize conformers using ETKDG method implemented in RDKit.

```
python compute_niso.py
python randomize_conf.py
```

`python compute_niso.py` - records the number of molecular graph automorphisms for each test molecule and saves as `niso_timings.json`.

`python randomize_conf.py` - randomize conformers using either Ringo or RDKit, optimizes them using RDKit and, finally, performs distance-based topology checks (no NBO this type) that structures are okay.

The structures `assemble_initial/start_conformers/*.sdf` can be used for benchmarking!
